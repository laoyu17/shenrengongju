name: CI

on:
  push:
    branches: ["main"]
  pull_request:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  test:
    name: Test (${{ matrix.os }})
    if: github.event_name != 'schedule'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.11"]
    env:
      QT_QPA_PLATFORM: offscreen
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Linux Qt runtime deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libegl1 \
            libgl1 \
            libxkbcommon-x11-0 \
            libdbus-1-3 \
            libxcb-cursor0

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev,ui]

      - name: Run unit tests
        run: python -m pytest -q

  perf:
    name: Perf Report (PR/Push, 100/300)
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    needs: test
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev]

      - name: Run performance baseline
        run: |
          python scripts/perf_baseline.py \
            --tasks 100,300 \
            --max-wall-ms 1500,4000 \
            --threshold-version ci-soft-v2-pr \
            --output artifacts/perf/perf-baseline.json

      - name: Add perf summary
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path
          path = Path("artifacts/perf/perf-baseline.json")
          if not path.exists():
              print("Perf report missing")
              raise SystemExit(0)
          report = json.loads(path.read_text(encoding="utf-8"))
          lines = ["## Perf Report (PR/Push soft gate)", f"- git_sha: {report.get('git_sha', 'unknown')}"]
          for case in report.get("cases", []):
              lines.append(
                  f"- {case.get('case_name', case.get('task_count'))}: "
                  f"wall_ms={case.get('wall_time_ms')} events={case.get('event_count')} "
                  f"reason={case.get('pass_reason')}"
              )
          summary = Path(os.environ["GITHUB_STEP_SUMMARY"])
          summary.write_text("\n".join(lines) + "\n", encoding="utf-8")
          PY

      - name: Upload perf report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-baseline-pr
          path: artifacts/perf/perf-baseline.json

  perf_nightly:
    name: Perf Nightly Trend (1000, non-blocking)
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev]

      - name: Run nightly 1000-task performance baseline
        run: |
          python scripts/perf_baseline.py \
            --tasks 1000 \
            --max-wall-ms 2500 \
            --threshold-version ci-nightly-v1 \
            --output artifacts/perf/perf-nightly-1000.json

      - name: Resolve previous nightly artifact
        id: prev_nightly
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = (context.ref || "").replace("refs/heads/", "");
            const workflowId = "ci.yml";
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowId,
              event: "schedule",
              branch: branch || undefined,
              per_page: 30,
            });
            const previous = runs.data.workflow_runs.find(
              (run) => run.id !== context.runId && run.conclusion === "success"
            );
            if (!previous) {
              core.info("No previous successful scheduled run found.");
              return;
            }
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: previous.id,
              per_page: 100,
            });
            const artifact = artifacts.data.artifacts.find(
              (item) => item.name === "perf-nightly-1000" && !item.expired
            );
            if (!artifact) {
              core.info(`Run ${previous.id} has no perf-nightly-1000 artifact.`);
              return;
            }
            core.setOutput("run_id", String(previous.id));
            core.setOutput("download_url", artifact.archive_download_url);

      - name: Download previous nightly artifact
        if: steps.prev_nightly.outputs.download_url != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACT_URL: ${{ steps.prev_nightly.outputs.download_url }}
        run: |
          mkdir -p artifacts/perf/prev
          curl -sSL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "${ARTIFACT_URL}" \
            -o artifacts/perf/prev/previous-nightly.zip
          python - <<'PY'
          from pathlib import Path
          import zipfile

          zip_path = Path("artifacts/perf/prev/previous-nightly.zip")
          out = Path("artifacts/perf/prev")
          if not zip_path.exists():
              raise SystemExit(0)
          with zipfile.ZipFile(zip_path) as zf:
              candidates = [
                  name for name in zf.namelist()
                  if Path(name).name == "perf-nightly-1000.json"
              ]
              if not candidates:
                  print("No perf-nightly-1000.json found in previous artifact; skip baseline restore.")
                  raise SystemExit(0)
              (out / "perf-nightly-1000.base.json").write_bytes(zf.read(candidates[0]))
          PY

      - name: Build nightly delta summary
        if: always()
        run: |
          python scripts/perf_delta.py \
            --current artifacts/perf/perf-nightly-1000.json \
            --base artifacts/perf/prev/perf-nightly-1000.base.json \
            --task-count 1000 \
            --highlight-pct 5 \
            --current-run-id "${{ github.run_id }}" \
            --base-run-id "${{ steps.prev_nightly.outputs.run_id }}" \
            --out artifacts/perf/perf-delta-summary.json

      - name: Add nightly perf summary
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path
          path = Path("artifacts/perf/perf-nightly-1000.json")
          if not path.exists():
              print("Nightly perf report missing")
              raise SystemExit(0)
          report = json.loads(path.read_text(encoding="utf-8"))
          lines = ["## Perf Nightly (1000 tasks, non-blocking)", f"- git_sha: {report.get('git_sha', 'unknown')}"]
          for case in report.get("cases", []):
              lines.append(
                  f"- {case.get('case_name', case.get('task_count'))}: "
                  f"wall_ms={case.get('wall_time_ms')} events={case.get('event_count')} "
                  f"reason={case.get('pass_reason')}"
              )
          delta_path = Path("artifacts/perf/perf-delta-summary.json")
          if delta_path.exists():
              delta = json.loads(delta_path.read_text(encoding="utf-8"))
              lines.append(f"- delta.status: {delta.get('status')}")
              lines.append(
                  f"- delta.base_run_id: {delta.get('base_run_id') or 'none'}"
              )
              wall = delta.get("wall_time_ms", {})
              lines.append(
                  f"- delta.wall_ms: base={wall.get('base')} current={wall.get('current')} "
                  f"delta={wall.get('delta')} pct={wall.get('delta_pct')}"
              )
              lines.append(f"- delta.highlight: {delta.get('highlight')}")
          summary = Path(os.environ["GITHUB_STEP_SUMMARY"])
          summary.write_text("\n".join(lines) + "\n", encoding="utf-8")
          PY

      - name: Upload nightly perf report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-nightly-1000
          path: artifacts/perf/perf-nightly-1000.json

      - name: Upload nightly delta summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-nightly-delta
          path: artifacts/perf/perf-delta-summary.json
