name: CI

on:
  push:
    branches: ["main"]
  pull_request:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  test:
    name: Test (${{ matrix.os }})
    if: github.event_name != 'schedule'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.11"]
    env:
      QT_QPA_PLATFORM: offscreen
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Linux Qt runtime deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libegl1 \
            libgl1 \
            libxkbcommon-x11-0 \
            libdbus-1-3 \
            libxcb-cursor0

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev,ui]

      - name: Run unit tests
        run: python -m pytest -q

  perf:
    name: Perf Report (PR/Push, 100/300)
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    needs: test
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev]

      - name: Run performance baseline
        run: |
          python scripts/perf_baseline.py \
            --tasks 100,300 \
            --max-wall-ms 1500,4000 \
            --threshold-version ci-soft-v2-pr \
            --output artifacts/perf/perf-baseline.json

      - name: Add perf summary
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path
          path = Path("artifacts/perf/perf-baseline.json")
          if not path.exists():
              print("Perf report missing")
              raise SystemExit(0)
          report = json.loads(path.read_text(encoding="utf-8"))
          lines = ["## Perf Report (PR/Push soft gate)", f"- git_sha: {report.get('git_sha', 'unknown')}"]
          for case in report.get("cases", []):
              lines.append(
                  f"- {case.get('case_name', case.get('task_count'))}: "
                  f"wall_ms={case.get('wall_time_ms')} events={case.get('event_count')} "
                  f"reason={case.get('pass_reason')}"
              )
          summary = Path(os.environ["GITHUB_STEP_SUMMARY"])
          summary.write_text("\n".join(lines) + "\n", encoding="utf-8")
          PY

      - name: Upload perf report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-baseline-pr
          path: artifacts/perf/perf-baseline.json

  perf_nightly:
    name: Perf Nightly Trend (1000, non-blocking)
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev]

      - name: Run nightly 1000-task performance baseline
        run: |
          python scripts/perf_baseline.py \
            --tasks 1000 \
            --max-wall-ms 2500 \
            --threshold-version ci-nightly-v1 \
            --output artifacts/perf/perf-nightly-1000.json

      - name: Add nightly perf summary
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path
          path = Path("artifacts/perf/perf-nightly-1000.json")
          if not path.exists():
              print("Nightly perf report missing")
              raise SystemExit(0)
          report = json.loads(path.read_text(encoding="utf-8"))
          lines = ["## Perf Nightly (1000 tasks, non-blocking)", f"- git_sha: {report.get('git_sha', 'unknown')}"]
          for case in report.get("cases", []):
              lines.append(
                  f"- {case.get('case_name', case.get('task_count'))}: "
                  f"wall_ms={case.get('wall_time_ms')} events={case.get('event_count')} "
                  f"reason={case.get('pass_reason')}"
              )
          summary = Path(os.environ["GITHUB_STEP_SUMMARY"])
          summary.write_text("\n".join(lines) + "\n", encoding="utf-8")
          PY

      - name: Upload nightly perf report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-baseline-nightly-1000-${{ github.run_id }}
          path: artifacts/perf/perf-nightly-1000.json
