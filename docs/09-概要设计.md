# 概要设计说明书（RTOS 多核异构调度仿真工具）

## 0. 文档控制
- 版本：v0.3
- 状态：S2 实施对齐版
- 更新日期：2026-02-17
- 关联文档：`project/docs/08-综合架构设计.md`

## 1. 目标与范围
### 1.1 设计目标
- 架构可扩展：调度策略、资源协议、开销模型、指标可插拔
- 行为可复现：配置驱动 + 固定随机种子
- 可视化可解释：事件日志与指标一致

### 1.2 覆盖范围
- 仿真核心、事件模型、调度接口、资源协议、指标与可视化输出
- 不包含：GUI 具体实现细节与底层 OS 绑定

## 2. 设计约束与假设
- 任务以 DAG 表达，子任务分段顺序执行
- 资源互斥访问，支持资源绑定到核
- 支持抢占与迁移

## 3. 总体架构概述

```
rtos_sim/
  core/          # 仿真驱动/事件循环/trace hooks
  events/        # 事件定义与事件总线
  model/         # Task/Job/Platform/Resource/DAG/Segment
  schedulers/    # 调度策略与注册机制
  protocols/     # 资源协议（mutex/pip/pcp）
  etm/           # 执行时间模型（constant/table-based）
  overheads/     # 开销模型（切换/迁移/调度开销）
  metrics/       # 指标计算与可视化数据
  io/            # 配置加载/校验/实验批跑
  cli/           # CLI 真相源入口（validate/run/ui/batch-run）
  ui/            # PyQt6 + PyQtGraph 展示层
```

## 4. 关键模块设计

### 4.1 core（仿真核心）
**职责**：时间推进、事件循环、执行调度决策、触发事件与日志。

**输入**：ModelSpec、Scheduler、OverheadModel、ResourceProtocol
**输出**：事件流（SimEvent）

**关键接口**：
```python
class ISimEngine:
    def build(spec: ModelSpec) -> None: ...
    def run(until: float | None = None) -> None: ...
    def step(delta: float | None = None) -> None: ...
    def pause() -> None: ...
    def resume() -> None: ...
    def stop() -> None: ...
    def reset() -> None: ...
    def subscribe(handler: Callable[[SimEvent], None]) -> None: ...
```

### 4.2 events（事件模型）
**职责**：事件标准化与统一总线。

**事件类型**：
- JobReleased / SegmentReady / SegmentStart / SegmentEnd
- ResourceAcquire / ResourceRelease / SegmentBlocked / SegmentUnblocked
- Preempt / Migrate / DeadlineMiss / JobComplete
- 事件标准字段：`event_id, seq, correlation_id, time, type, job_id, segment_id, core_id, resource_id, payload`

### 4.3 model（领域模型）
**职责**：模型实体与约束表达。

**核心实体**：TaskGraph、Subtask、Segment、Resource、Core/Platform。
**到达过程**：兼容 legacy `arrival_model/min_inter_arrival/max_inter_arrival`，并支持统一 `arrival_process`（`fixed/uniform/poisson/one_shot`）。

### 4.4 schedulers（调度策略）
**职责**：调度算法实现与注册机制。

**参数化（S3）**：支持 `scheduler.params.tie_breaker`、`scheduler.params.allow_preempt`。

**关键接口**：
```python
class IScheduler:
    def init(context: ScheduleContext) -> None: ...
    def on_release(job: Job) -> None: ...
    def on_complete(job: Job) -> None: ...
    def on_segment_ready(seg: Segment) -> None: ...
    def schedule(now: float, snapshot: ScheduleSnapshot) -> list[Decision]: ...
```

### 4.5 protocols（资源协议）
**职责**：资源互斥、阻塞与唤醒语义统一，支持优先级更新（PIP/PCP）。

**接口**：
```python
class IResourceProtocol:
    def configure(resources: dict[str, ResourceRuntimeSpec]) -> None: ...
    def request(seg_key: str, res_id: str, core_id: str, priority: float) -> ResourceRequestResult: ...
    def release(seg_key: str, res_id: str) -> ResourceReleaseResult: ...
    def on_block(seg_key: str, res_id: str) -> None: ...
    def on_wake(seg_key: str, res_id: str) -> None: ...
```

### 4.6 etm（执行时间模型）
**职责**：根据核速率和模型参数估算分段执行时长。

**接口**：
```python
class IExecutionTimeModel:
    def estimate(
        segment_wcet: float,
        core_speed: float,
        now: float,
        *,
        task_id: str | None = None,
        subtask_id: str | None = None,
        segment_id: str | None = None,
        core_id: str | None = None,
    ) -> float: ...
    def on_exec(segment_key: str, core_id: str, dt: float) -> None: ...
```

### 4.7 overheads（开销模型）
**职责**：上下文切换、迁移、调度开销计算。

**接口**：
```python
class IOverheadModel:
    def on_context_switch(job: Job, core: Core) -> float: ...
    def on_migration(job: Job, from_core: Core, to_core: Core) -> float: ...
    def on_schedule(scheduler: IScheduler) -> float: ...
```

### 4.8 metrics（指标统计）
**职责**：消费事件流并生成统计指标。
**审计规则**：除资源配对/死锁外，新增协议一致性规则（`pip_priority_chain_consistency`、`pcp_ceiling_transition_consistency`）。

**接口**：
```python
class IMetric:
    def consume(event: SimEvent) -> None: ...
    def report() -> dict: ...
```

### 4.9 io（配置与实验）
**职责**：配置解析/校验、批量实验、结果汇总。

### 4.10 cli（命令入口）
**职责**：提供 validate/run/ui/batch-run 子命令，导出事件、指标与批量汇总。

**工程化扩展**：性能基线脚本 `scripts/perf_baseline.py` 作为 CI 门禁输入。

### 4.11 ui（可视化）
**职责**：PyQt6 结构化表单（多任务/多资源表格 CRUD + 单任务 DAG 侧栏/拖拽连线/节点自由拖动/自动布局雏形 + 表格校验高亮/阻断）+ YAML 文本配置编辑、运行控制、PyQtGraph Gantt/指标展示。
**约束**：仿真后台线程运行，Qt 主线程渲染；UI 只消费事件流，CLI 事件日志为真相源。

## 5. 运行流程（概要）
1. io/config 解析配置 -> 构建 model 对象
2. core.build 初始化仿真，调度器/开销模型/协议注入
3. core.run 推进时间，调度器输出决策
4. events 产生事件，metrics/ui 消费
5. 输出指标/报告

## 6. 关键设计决策
- 调度器无副作用，只输出决策
- 事件即真相，所有状态变化必须有事件记录
- 插件化机制用于调度、开销与指标
- GUI 不维护独立真相源，避免与 CLI 结果漂移

## 7. 非功能性设计
- 可扩展：通过注册机制新增策略
- 可复现：固定随机种子
- 性能：事件聚合与可视化采样

## 8. 风险与对策
- 风险：语义不统一导致核心复杂化
  - 对策：定义统一资源协议语义与抢占规则
- 风险：事件粒度过细影响性能
  - 对策：提供事件采样/聚合层

## 9. 验证与验收建议
- 采用 SRS 中验收用例矩阵进行功能验证
- 记录事件日志与指标输出一致性
