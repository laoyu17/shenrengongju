# 详细设计说明书（RTOS 多核异构调度仿真工具）

## 0. 文档控制
- 版本：v0.2
- 状态：实现对齐版
- 更新日期：2026-02-13
- 关联文档：
  - `project/docs/01-需求规格说明书提纲.md`
  - `project/docs/04-详细版SRS.md`
  - `project/docs/08-综合架构设计.md`
  - `project/docs/09-概要设计.md`

## 1. 设计范围与假设
本设计覆盖仿真核心、事件系统、领域模型、调度策略、开销模型、指标统计、配置与可视化集成。假设任务采用 DAG 表达，子任务由分段顺序执行；资源互斥访问，可绑定到特定核；支持抢占与迁移。

## 2. 设计目标
- **可扩展性**：调度策略、资源协议、开销模型与指标模块可插拔。
- **可复现性**：配置驱动、固定随机种子、事件流可回放。
- **可解释性**：状态变化必须对应事件记录，指标可追溯。

## 3. 术语与关键概念
- **TaskGraph**：任务集合中的一个任务，包含 DAG 子任务。
- **Subtask**：DAG 节点，具有前驱/后继关系。
- **Segment**：子任务内顺序执行单元，可被抢占/阻塞。
- **Resource Binding**：共享资源固定在指定核上访问。
- **Hyper-Period**：时间确定性任务的超周期。

## 4. 总体设计概览

```
rtos_sim/
  core/          # 仿真驱动/事件循环/trace hooks
  events/        # 事件定义与事件总线
  model/         # Task/Job/Platform/Resource/DAG/Segment
  schedulers/    # 调度策略与注册机制
  protocols/     # 资源协议（mutex/pip/pcp）
  etm/           # 执行时间模型（constant/table-based）
  overheads/     # 开销模型（切换/迁移/调度开销）
  metrics/       # 指标计算与可视化数据
  io/            # 配置加载/校验/实验批跑
  cli/           # CLI 真相源入口（validate/run/ui）
  ui/            # PyQt6 + PyQtGraph 展示层
```

核心思想：**仿真核心只驱动时间与执行，调度器只输出决策，事件作为系统事实来源**。

## 5. 领域模型详细设计（model/）

### 5.1 Platform/Core
- **ProcessorType**：`id, name, core_count, speed_factor`
- **Core**：`id, type_id, speed_factor`

**约束**：
- `core_count >= 1`，`speed_factor > 0`
- `Core.type_id` 必须指向存在的 ProcessorType

### 5.2 Resource
- **Resource**：`id, name, bound_core_id, protocol`

**约束**：
- `bound_core_id` 必须存在
- `protocol` 必须在支持列表内（如 mutex/pip/pcp）

### 5.3 TaskGraph
- **TaskGraph**：`id, name, task_type, period, deadline, arrival, abort_on_miss`
- **Subtask**：`id, predecessors, successors, segments`
- **Segment**：`id, index, wcet, acet, required_resources, mapping_hint`

**约束**：
- DAG 无环；`Subtask.id` 唯一
- `Segment.index` 从 1 递增
- `mapping_hint` 必须是存在的 `core_id` 或为空

## 6. 事件模型详细设计（events/）

### 6.1 事件基类
- 字段：`event_id, seq, correlation_id, time, type, job_id, segment_id, core_id, resource_id, payload`
- 行为：只读、可序列化

### 6.2 事件类型
- **调度相关**：`JobReleased, SegmentReady, SegmentStart, SegmentEnd, JobComplete`
- **资源相关**：`ResourceAcquire, ResourceRelease, SegmentBlocked, SegmentUnblocked`
- **抢占迁移**：`Preempt, Migrate`
- **异常与约束**：`DeadlineMiss`

### 6.3 事件总线
- `publish(event)`：事件派发
- `subscribe(handler)`：订阅事件流

## 7. 仿真核心详细设计（core/）

### 7.1 生命周期
1. `build(spec)`：初始化模型、调度器、资源协议、开销模型
2. `run(until)`：推进时间，驱动事件循环
3. `pause/reset/step`：控制仿真节奏

### 7.2 调度执行流程
- Job release -> 调度器决策 -> 分配到核 -> 分段执行
- 资源请求 -> 阻塞/唤醒 -> 事件记录
- 发生抢占 -> 保存状态 -> 迁移/恢复

### 7.3 SimPy 映射策略（如采用）
- `Environment`：全局时间
- `Segment`：协程进程
- `Resource`：`Resource/PreemptiveResource` 或自定义协议封装
- 事件点作为日志与指标采样钩子

## 8. 调度策略详细设计（schedulers/）

### 8.1 接口定义
```python
class IScheduler:
    def init(context: ScheduleContext) -> None: ...
    def on_release(job: Job) -> None: ...
    def on_complete(job: Job) -> None: ...
    def on_segment_ready(seg: Segment) -> None: ...
    def schedule(now: float, snapshot: ScheduleSnapshot) -> list[Decision]: ...
```

### 8.2 决策结构
- `Decision(action, job_id, segment_id, from_core, to_core, reason)`
- `action` 取值：`dispatch | preempt | migrate | idle`

### 8.3 内置算法
- EDF/RM 作为基线策略
- 支持扩展用户自定义策略

## 9. 资源协议与抢占语义（protocols/ + core）

### 9.0 资源协议接口
```python
class IResourceProtocol:
    def request(seg_key: str, res_id: str, core_id: str) -> ResourceRequestResult: ...
    def release(seg_key: str, res_id: str) -> list[str]: ...
    def on_block(seg_key: str, res_id: str) -> None: ...
    def on_wake(seg_key: str, res_id: str) -> None: ...
```

### 9.1 默认协议（Mutex）
- 获取即占用，释放即唤醒
- 不支持资源内抢占

### 9.2 可选扩展
- **PIP**：优先级继承
- **PCP**：优先级天花板

### 9.3 抢占语义统一规则
- 抢占点限定在分段边界或显式可抢占点
- 被抢占分段保留剩余执行时间
- 发生 deadline miss 时记录 `DeadlineMiss` 事件，并按 `abort_on_miss` 决定是否终止作业

## 10. 执行时间模型详细设计（etm/）

### 10.1 接口
```python
class IExecutionTimeModel:
    def estimate(segment_wcet: float, core_speed: float, now: float) -> float: ...
    def on_exec(segment_key: str, core_id: str, dt: float) -> None: ...
```

### 10.2 实现建议
- `constant.py`：按 `wcet / core_speed` 估算
- 可扩展：表驱动或负载相关动态模型

## 11. 开销模型详细设计（overheads/）

### 11.1 接口
```python
class IOverheadModel:
    def on_context_switch(job: Job, core: Core) -> float: ...
    def on_migration(job: Job, from_core: Core, to_core: Core) -> float: ...
    def on_schedule(scheduler: IScheduler) -> float: ...
```

### 11.2 实现建议
- `simple.py`：固定常量开销
- 可扩展：按核类型/负载动态调整

## 12. 指标统计设计（metrics/）

### 12.1 指标类别
- lateness、deadline miss ratio
- utilization（核利用率）
- preempt/migrate 统计

### 12.2 数据来源
- 只消费事件流，不读取仿真内部状态

## 13. IO 与配置设计（io/）

### 13.1 配置格式
- JSON/YAML 版本化
- 详见 `project/docs/05-配置文件Schema草案.md`
- 当前实现版本：`0.2`（支持 `0.1 -> 0.2` 兼容迁移）

### 13.2 校验策略
- 结构校验 + 语义校验（DAG 无环、ID 唯一、绑定核存在）

### 13.3 批量实验
- 统一实验入口：参数组 -> 批量运行 -> 汇总报表

## 14. 可视化设计（ui/）
- 技术栈：PyQt6 + PyQtGraph
- 线程模型：仿真后台线程（SimulationWorker）+ Qt 主线程渲染
- 数据协议：事件增量批推送（64 条或 150ms 刷新阈值）
- 真相源：CLI/引擎事件流；UI 不维护独立状态真相源
- 首版范围：配置编辑（文本表单）+ 运行控制 + Gantt/指标展示
- 发布策略：先 Windows 单平台

## 15. 性能与可扩展性
- 事件流支持采样与聚合
- 大规模 DAG 采用延迟统计或分层采样

## 16. 错误处理与日志
- 配置加载/校验失败应返回可定位错误
- 运行期异常必须形成事件与日志记录

## 17. 测试与验证
- 单元测试：模型约束、调度器接口、事件记录
- 集成测试：SRS 验收矩阵场景
- 可复现测试：固定 seed 的一致性验证
- GUI 一致性测试：GUI 展示结果需与 CLI 事件/指标一致

## 18. 交付物与后续扩展
- 可交付：配置模板、基线算法、事件日志与指标
- 可扩展：新调度策略、新资源协议、新 ETM、新指标
