# RTOS 仿真项目实施审查报告（Docx 主基线）

- 审查日期：2026-02-18
- 审查基线：`/mnt/hgfs/_code/simpytool/250909-仿真工具-基础模型.docx`
- 对照范围：`docs/04`、`docs/08`、`docs/09`、`docs/10`、`docs/11`、`rtos_sim/*`、`tests/*`

> 说明（2026-02-18 晚间更新）：本报告保留“首轮基线审查”属性。  
> 其中 `core_count` 一致性、`batch-run` 严格失败返回码、`wait_for_deadlock` 规则已在后续 Phase 收敛；新增 `arrival_process` 与协议审计一致性规则后，请以 `docs/11-实施现状问题与Sprint规划.md` 的最新状态为准。
> 说明（2026-02-22 复核更新）：本文件保留首轮结论，同时补充最新验证快照（测试数、覆盖率、门禁现状）。

## 1. 执行摘要

项目已经完成“可运行的仿真内核 + 插件化调度/协议 + CLI/UI + 自动化测试”的主链路，整体开发方向与设计文档一致。

按 docx 模型口径评估，当前处于“工程可用、研究级语义未闭环”阶段：
- 已实现：核心仿真、DAG/Segment、资源绑定、EDF/RM、PIP/PCP（MVP）、事件追踪、指标统计、批量实验、UI 可视化。
- 部分实现：混合实时任务到达模型、证明级协议语义、规模化性能趋势治理。
- 未实现/缺口：研究级可证明资产（形式化证明/边界报告）、更丰富自定义到达分布、多方案实验报告模板。

## 2. 审查方法与证据

### 2.1 代码与文档核对
- 架构与接口：`docs/08-综合架构设计.md:13`、`docs/09-概要设计.md:24`、`docs/10-详细设计说明书.md:90`
- 功能需求与验收矩阵：`docs/04-详细版SRS.md:61`
- 当前实施声明：`docs/11-实施现状问题与Sprint规划.md:9`

### 2.2 运行验证
- 全量测试：`python -m pytest -q`（192 tests 通过）
- 覆盖率：`python -m pytest --cov=rtos_sim --cov-report=term-missing -q`（TOTAL 87%，其中 `cli/main` 100%）
- 性能抽样（本地）：300 tasks ≈ 331.98ms；1000 tasks ≈ 1749.10ms（脚本内 `_run_case`）

### 2.3 2026-02-22 快照补充
- 混合实时到达模型已支持统一 `arrival_process`（`fixed/uniform/poisson/one_shot`），随机零星场景具备基础表达能力（仍缺自定义分布插件化）。
- CI 性能门禁现状：PR 路径 100/300 软门禁，nightly 路径 1000 非阻断趋势任务 + delta 摘要。
- 研究级差距仍在“协议可证明性资产与模板化实验报告”，该结论与首轮审查保持一致。

## 3. Docx 基线映射（完成度矩阵）

| ID | Docx 模型要求 | 证据 | 状态 | 结论 |
|---|---|---|---|---|
| M-01 | 多处理器类型 + 多核 + 速度缩放 | `rtos_sim/model/spec.py:14`、`rtos_sim/core/engine.py:152`、`rtos_sim/etm/constant.py:1` | 已实现 | 平台与异构速度缩放可运行 |
| M-02 | 处理器类型核心数语义一致 | `rtos_sim/model/spec.py:129` | 已实现（后续修复） | 已校验 `processor_types.core_count` 与 `cores` 数量一致 |
| M-03 | 资源互斥 + 资源绑定核 | `rtos_sim/model/spec.py:163`、`rtos_sim/protocols/mutex.py:1`、`rtos_sim/protocols/pip.py:31`、`rtos_sim/protocols/pcp.py:46` | 已实现 | 支持 mutex/pip/pcp 且有绑定核校验 |
| M-04 | 任务 DAG（前驱后继） | `rtos_sim/model/spec.py:194`、`rtos_sim/model/spec.py:292` | 已实现 | 引用完整性与无环校验齐全 |
| M-05 | 子任务分段顺序执行（可抢占/阻塞） | `rtos_sim/model/spec.py:214`、`rtos_sim/core/engine.py:730` | 已实现 | index 连续约束 + 运行时状态机 |
| M-06 | 任务/子任务/分段到核映射层级 | `rtos_sim/model/spec.py:52`、`rtos_sim/core/engine.py:745` | 部分实现 | 仅原生支持 segment 级 `mapping_hint` |
| M-07 | 任务/子任务/分段资源访问关系集合 | `rtos_sim/model/spec.py:217`、`rtos_sim/analysis/model_relations.py:1` | 已实现（基础版） | 已支持 `inspect-model` 导出关系集合（JSON/CSV） |
| M-08 | 周期/偶发/零星（随机）到达模型 | `rtos_sim/model/spec.py:72`、`rtos_sim/core/engine.py:677` | 部分实现 | 已支持 `fixed/uniform/poisson/one_shot`；仍缺自定义分布插件化 |
| M-09 | 时间确定性：定时定点 + 超周期重复 | `rtos_sim/model/spec.py:232`、`rtos_sim/core/engine.py:464`、`rtos_sim/core/engine.py:656` | 部分实现 | ready offset + hyper-period 已有；缺全局可证明调度约束 |
| M-10 | 动态实时：截止期约束 | `rtos_sim/core/engine.py:497`、`rtos_sim/events/types.py:23`、`rtos_sim/metrics/core.py:110` | 已实现 | DeadlineMiss 与统计链路完整 |
| M-11 | 非实时尽力调度 | `rtos_sim/model/spec.py:12`、`rtos_sim/core/engine.py:684` | 已实现 | `non_rt` 任务支持 |
| M-12 | 大规模任务集（典型 >=1000） | `scripts/perf_baseline.py:122` | 部分实现 | 已有 nightly 1000 非阻断趋势门禁；尚未进入 PR 阻断门禁 |

## 4. 已验证 Bug（可复现）

### B-01（高，已修复）平台模型语义缺陷：`core_count` 不参与一致性校验
- 现象：配置中 `processor_types.core_count=4` 且仅声明 1 个 core，`validate` 仍通过。
- 当前状态：已在后续 Phase 修复，详见 `docs/11-实施现状问题与Sprint规划.md`。
- 复现：临时构造不一致配置，执行 `python -m rtos_sim.cli.main validate -c <file>` 返回 0。
- 影响：平台容量语义失真，可能导致实验模型与论文/设计参数不一致。
- 建议修复：在 `PlatformSpec.validate_platform` 增加按 `type_id` 聚合计数，并与 `core_count` 强一致校验（或提供 warn/strict 策略）。

### B-02（中，已修复）批量实验部分失败时 CLI 仍返回成功码
- 现象：`batch-run` 中存在失败用例（`failed>0`）时，命令仍返回 0。
- 当前状态：已在后续 Phase 修复，新增 `--strict-fail-on-error`。
- 复现：构造一组合法+非法组合后运行 `batch-run`，输出 `failed=1` 且进程退出码为 0。
- 影响：CI/自动化流水线无法基于退出码识别批跑失败。
- 建议修复：新增 `--strict-fail-on-error`（默认 false），开启时若 `failed_runs>0` 返回非 0。

### B-03（中）实施现状文档与真实状态不一致
- 现象：历史版本存在测试数快照漂移。
- 证据：当前快照为 192 tests、总覆盖率 87%。
- 影响：管理与排期依据失真，可能误判质量趋势。
- 建议修复：将测试与覆盖率快照改为“自动生成时间戳 + CI artifact 链接”，避免手写过期。

## 5. 设计/架构风险（未必已复现）

### R-01（高）混合实时到达模型未完全覆盖 docx 语义
- 证据：已支持 `arrival_process.fixed/uniform/poisson/one_shot`，但缺少“用户自定义分布插件化”能力（`rtos_sim/model/spec.py:72`）。
- 风险：研究场景可表达常见随机到达，但特定分布实验仍需改代码扩展。

### R-02（高）协议实现可用但缺“证明级”验证资产
- 证据：`pip/pcp` 已实现并有测试（`rtos_sim/protocols/pip.py:10`、`rtos_sim/protocols/pcp.py:10`、`tests/test_protocol_pcp.py:1`），但缺系统性反例集与可证明边界报告。
- 风险：在复杂锁链路场景下难以给出研究级可信结论。

### R-03（中）模型关系审查自动化仍待增强
- 证据：已提供 `inspect-model` 基础导出，但尚未接入“规则自动判定 + 报告模板”链路（`rtos_sim/analysis/model_relations.py:1`）。
- 风险：关系数据可导出但人工审查成本仍偏高。

### R-04（中）UI 模块体量过大，维护与回归成本上升
- 证据：`rtos_sim/ui/app.py` 约 1900+ 行，覆盖率 79%（覆盖率报告）。
- 风险：后续复杂交互迭代时引入回归风险偏高。

## 6. 完成度评估（Docx 主基线）

评分口径：建模语义 25% + 调度协议 25% + 事件指标 15% + UI/可用性 15% + 工程质量 20%。

| 维度 | 分值 | 说明 |
|---|---:|---|
| 建模语义 | 19/25 | DAG/Segment/绑定完善，但 `core_count` 与随机零星任务缺口明显 |
| 调度与协议 | 19/25 | EDF/RM + mutex/pip/pcp 可用，证明级语义与死锁治理待补 |
| 事件与指标 | 13/15 | 事件链路完整、审计机制已接入 |
| UI 与可用性 | 12/15 | 结构化编辑与实时 Gantt 已可用，复杂 DAG 编辑仍有限 |
| 工程质量 | 16/20 | 测试与 CI 基线较好，但性能/批跑门禁仍可加强 |
| **总分** | **79/100** | **“工程可用，研究级闭环未完成”** |

## 7. 是否按设计文档大方向开发

结论：**是（总体对齐）**。

对齐证据：
- 分层与模块边界与设计文档一致：`docs/08-综合架构设计.md:13` 对应 `rtos_sim/*` 实际目录。
- 接口化思路落地：`IScheduler/IResourceProtocol/IExecutionTimeModel/IOverheadModel` 与实现注册机制一致（`rtos_sim/schedulers/base.py:16`、`rtos_sim/protocols/base.py:1`、`rtos_sim/etm/registry.py:14`、`rtos_sim/overheads/registry.py:22`）。
- 事件驱动真相源落地：`events -> metrics/ui` 管线可用（`rtos_sim/core/engine.py:229`、`rtos_sim/metrics/core.py:32`、`rtos_sim/ui/worker.py:74`）。

偏差点：
- 设计文档与现状文档存在时效漂移（测试数/覆盖率/命令集描述）。
- 研究型能力（证明、死锁检测、随机到达建模）未完全达到 docx 期望深度。

## 8. 距离满足“仿真模型目标”还有多远

按目标层级估算：
- **工程可用目标**：已达成约 85%（可用于功能演示、策略对比、教学/工程预研）。
- **研究级模型目标（docx 完整语义）**：约 65%（关键差距在随机到达、可证明性、死锁检测、大规模门禁）。
- **综合距离**：约还需 **2–3 个迭代（4–6 周）**，可达到“研究可复现 + 工程可交付”的平衡版本。

## 9. 建议实施路线（可执行整改清单）

### Phase A（1 周，P0）语义一致性与门禁修复
1. 增加 `core_count` 一致性校验 + 单元测试。
2. 为 `batch-run` 增加严格失败返回码开关。
3. 清理 `docs/11` 状态漂移项，改为 CI 自动注入。

验收：
- 新增回归测试通过；
- batch 严格模式可在 CI 正确 fail；
- 文档快照可追溯到 CI artifact。

### Phase B（1–2 周，P1）模型能力补齐
1. 扩展动态任务到达模型（周期/偶发/零星随机）。
2. 在审计模块加入死锁检测（等待图循环）与规则报告。
3. 增加协议复杂场景测试集（多锁链路、优先级传播链）。

验收：
- 新增配置字段可表达随机到达；
- audit 报告新增 deadlock rule；
- 协议回归覆盖新增复杂场景。

### Phase C（2 周，P2）规模化与发布化
1. 将 1000 任务场景纳入性能基线（软门禁 -> 可选硬门禁）。
2. UI 模块分层拆分（编辑器/渲染/状态管理）降低回归风险。
3. 形成“实验模板 + 对比报告模板 + 发布手册”。

验收：
- 1000 任务性能曲线可追踪；
- UI 关键路径回归稳定；
- 非开发用户可按手册复现实验结果。

## 10. 附：关键引用
- `rtos_sim/model/spec.py:129`
- `rtos_sim/cli/main.py:175`
- `rtos_sim/analysis/audit.py:16`
- `docs/04-详细版SRS.md:114`
- `docs/11-实施现状问题与Sprint规划.md:61`
