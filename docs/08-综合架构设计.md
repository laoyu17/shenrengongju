# 综合架构设计（RTOS 多核异构调度仿真工具）

## 0. 文档控制
- 版本：v0.3
- 状态：S2 实施对齐版
- 更新日期：2026-02-17

## 1. 设计目标
- 在可扩展与可复现的前提下，支持 DAG 任务、分段执行、资源互斥/绑定、混合实时性。
- 模块解耦：核心仿真、模型定义、调度策略、开销模型、指标统计、IO、可视化分离。
- 支持批量实验与策略对比。

## 2. 总体分层（融合版）

```
rtos_sim/
  core/          # 仿真驱动/事件循环/trace hooks
  events/        # 事件定义与事件总线
  model/         # Task/Job/Platform/Resource/DAG/Segment
  schedulers/    # 调度策略与注册机制
  protocols/     # 资源访问协议（mutex/pip/pcp）
  etm/           # 执行时间模型（constant/table-based）
  overheads/     # 开销模型（切换/迁移/调度开销）
  metrics/       # 指标计算与可视化数据
  io/            # 配置加载/校验/实验批跑
  cli/           # CLI 真相源入口（validate/run/ui/batch-run）
  ui/            # PyQt6 + PyQtGraph 展示层
```

## 3. 模块职责与边界

### 3.1 core/
- 职责：仿真时间推进、事件循环、统一调度入口、trace hooks。
- 边界：不包含调度策略与模型解析，仅调用调度器与模型对象。

### 3.2 events/
- 职责：统一事件定义（release/dispatch/preempt/migrate/complete）、事件总线。
- 边界：不做业务决策，仅承载时序数据。

### 3.3 model/
- 职责：Task/Job/DAG/Subtask/Segment/Resource/Platform 等核心领域模型。
- 边界：不包含调度算法与仿真控制逻辑。

### 3.4 schedulers/
- 职责：调度算法实现、策略注册与配置。
- 边界：通过统一接口对 core 产生调度决策。
- 当前参数化能力：`tie_breaker`、`allow_preempt`（通过 `scheduler.params` 驱动）。

### 3.5 protocols/
- 职责：资源互斥协议实现（Mutex/PIP/PCP），提供请求/释放、优先级更新与唤醒语义。
- 边界：只管理资源访问状态，不直接调度 CPU。

### 3.6 etm/
- 职责：执行时间估计（按核速率缩放、可扩展动态模型）。
- 边界：只提供耗时估计，不修改运行队列。

### 3.7 overheads/
- 职责：上下文切换、迁移、调度开销模型。
- 边界：提供可插拔开销估算，不直接操作调度逻辑。

### 3.8 metrics/
- 职责：指标计算（lateness、utilization、gantt 数据）。
- 边界：只消费事件流，不修改仿真状态。

### 3.9 io/
- 职责：配置加载/校验（YAML/JSON）、实验批跑与结果汇总。
- 边界：不直接参与仿真循环。

### 3.10 cli/
- 职责：统一命令入口，提供 `validate/run/ui/batch-run` 命令。
- 边界：CLI 只编排，不承载仿真核心逻辑。

### 3.11 ui/
- 职责：PyQt6 结构化表单（含多任务/多资源表格化编辑、单任务 DAG 雏形编辑、节点自由拖动、自动布局、拖拽连线循环检测、表格校验高亮/阻断）+ YAML 文本配置编辑、运行控制、实时 Gantt/指标展示。
- 边界：UI 只消费事件流，CLI 事件日志为真相源。

## 4. 核心数据流
1. io/config 解析配置 -> 构建 model 对象
2. core 启动仿真 -> 事件循环推进
3. schedulers 输出调度决策 -> core 执行
4. protocols + etm + overheads 共同影响执行推进
5. events 输出事件流 -> metrics/ui 消费

## 5. 核心接口（草案）

### 5.1 调度器接口
```python
class IScheduler:
    def init(context: ScheduleContext) -> None: ...
    def on_release(job: Job) -> None: ...
    def on_complete(job: Job) -> None: ...
    def on_segment_ready(seg: Segment) -> None: ...
    def schedule(now: float, snapshot: ScheduleSnapshot) -> list[Decision]: ...
```

### 5.2 仿真核心接口
```python
class ISimEngine:
    def build(spec: ModelSpec) -> None: ...
    def run(until: float | None = None) -> None: ...
    def step(delta: float | None = None) -> None: ...
    def pause() -> None: ...
    def reset() -> None: ...
    def subscribe(handler: Callable[[SimEvent], None]) -> None: ...
```

### 5.3 开销模型接口
```python
class IOverheadModel:
    def on_context_switch(job: Job, core: Core) -> float: ...
    def on_migration(job: Job, from_core: Core, to_core: Core) -> float: ...
    def on_schedule(scheduler: IScheduler) -> float: ...
```

### 5.4 资源协议接口
```python
class IResourceProtocol:
    def configure(resources: dict[str, ResourceRuntimeSpec]) -> None: ...
    def request(seg_key: str, res_id: str, core_id: str, priority: float) -> ResourceRequestResult: ...
    def release(seg_key: str, res_id: str) -> ResourceReleaseResult: ...
    def on_block(seg_key: str, res_id: str) -> None: ...
    def on_wake(seg_key: str, res_id: str) -> None: ...
```

### 5.5 执行时间模型接口
```python
class IExecutionTimeModel:
    def estimate(segment_wcet: float, core_speed: float, now: float) -> float: ...
    def on_exec(segment_key: str, core_id: str, dt: float) -> None: ...
```

### 5.6 指标接口
```python
class IMetric:
    def consume(event: SimEvent) -> None: ...
    def report() -> dict: ...
```

## 6. 扩展点
- schedulers：新增算法类，注册即可使用
- protocols：新增资源协议，实现接口即可替换
- etm：新增执行时间模型，实现接口即可替换
- overheads：新增成本模型，实现接口即可替换
- metrics：新增指标模块，消费事件流即可
- ui：新增可视化后端

## 7. 关键设计原则
- **调度器无副作用**：只生成决策，不直接修改仿真状态
- **事件即真相**：状态变化必须形成事件记录
- **插件化**：调度/开销/指标可独立替换
- **可复现**：配置驱动 + 固定随机种子
- **GUI 与 CLI 一致性**：GUI 仅消费事件流，不作为状态真相源

## 8. 风险与权衡
- 事件粒度提升会增加性能压力，需聚合统计与采样
- 分段级调度与资源绑定复杂，建议在 core 内部统一处理抢占/阻塞语义
- CI 性能门禁阈值需持续校准（100/300 tasks 基线会随环境波动）。
